---
title: "HTTPS 分享"
date: 2023-09-12T00:23:00+08:00
tags: [https,cryptography]
toc: true
---

## 引言

这是2019年3月一次内部技术分享，当时在笔记上留下了一些大纲，分享时的PPT已经不见了，借此机会再写一遍分享内容，于自己是一次知识巩固，于朋友们也算得上是一次技术交流。

## 先聊聊密码学

谈到HTTPS，大家首先想到的是安全和加密通信。所以在开始HTTPS之旅前，有必要先聊一些密码学的内容。

### 古典密码

密码并不是一个很新潮的技术，我甚至怀疑从有人类文明开始，密码技术就诞生了。毕竟我们每个人心底里都藏着那没多不想让人知道的秘密😊

我们先来看看比较古老的密码。

#### 密码棒

密码棒是一种非常古老的密码，看着也有点像小时候的游戏。用一个纸条或者布条缠绕在有多个面（例如4个面）的棒子上，然后竖着在每个面上写字，写完后将纸条或者布条拉直，这时候得到的就是被打乱顺序的文字了。这也算得上一种密码吧！

{{< figureCupper
img="figure1-scytale.png"
caption="密码棒 参考[wiki](https://zh.wikipedia.org/wiki/密碼棒)"
command="Resize"
options="260x" >}}

间接的证据指出，最早提到密码棒的是一位公元前7世纪的希腊诗人阿尔基罗库斯，后来的希腊和罗马作家也在作品提到。

希腊历史学家普鲁塔克（Plutarch）曾写下密码棒的用法

wiki 上给了一个例子，按照上述方法处理 "Help me I am under attack" 这句话，加解密过程为：

加密过程：明文4个文字绕一圈，所以可以绕棒子5圈，故我们按照5个文字分一组，然后竖着读取每一列。（想象一下）：

```
H E L P M
E I A M U
N D E R A
T T A C K
```

得到密文：

```
HENTEIDTLAEAPMRCMUAK
```

解密过程则相反：将密文4个文字一组分组（每间隔3个文字取一个，到尾部后绕回即可。）

```
H E N T---------
E I D T---------
L A E A--------
P M R C---------
M U A K---------
```

得到明文：

```
HELPMEIAMUNDERATTACK
```


#### 凯撒密码

凯撒密码，即是人们常说的变换加密，根据苏维托尼乌斯的记载，凯撒曾用此方法对重要的军事信息进行加密。

{{< figureCupper
img="figure2-caesar-cipher.png"
caption="凯撒密码 参考[wiki](https://zh.wikipedia.org/wiki/凱撒密碼)"
command="Resize"
options="480x" >}}

对于字母文字而言，可以理解为按照一个固定的偏移量在字母表上将原始字母替换成目标字母。其变种也可以是预先设置好原始字母表和目标字母表的映射关系，然后做字母替换。

针对第一种情况，在偏移量为3时的一个例子

```
# 字母表
ABCDEFGHIJKLMNOPQRSTUVWXYZ
DEFGHIJKLMNOPQRSTUVWXYZABC

# 明文
THE QUICK BROWN FOX JUMPS OVER THE LAZY DOG

# 密文
WKH TXLFN EURZQ IRA MXPSV RYHU WKH ODCB GRJ
```

如何破解这种密码呢？各位思考一下。

#### 维吉尼亚密码

维吉尼亚密码可以算是一种凯撒密码的变种，是使用一系列凯撒密码组成密码字母表的加密算法。详细信息各位可以去[wiki](https://zh.wikipedia.org/wiki/维吉尼亚密码)上阅读。这里我们给一个示例。

{{< figureCupper
img="figure3-Vigenère-square.png"
caption="维吉尼亚密码"
command="Resize"
options="480x" >}}

在一个凯撒密码中，字母表中的每一字母都会作一定的偏移，例如偏移量为3时，A就转换为了D、B转换为了E……而维吉尼亚密码则是由一些偏移量不同的凯撒密码组成。

为了生成密码，需要使用表格法。这一表格包括了26行字母表，每一行都由前一行向左偏移一位得到。具体使用哪一行字母表进行编译是基于密钥进行的，在过程中会不断地变换。

```
# 明文
ATTACKATDAWN

# 密钥
LEMONLEMONLE

# 密文
LXFOPVEFRNHR
```

其解密过程反向操作即可。

如何破解这种密码呢？各位思考一下。

#### 谜码机

恩尼格玛密码机（德语：Enigma，又译恩尼格密码机、哑谜机、奇谜机[1]或谜式密码机）是一种用于加密与解密文件的密码机。确切地说，恩尼格玛是对二战时期纳粹德国使用的一系列相似的转子机械加解密机器的统称，它包括了许多不同的型号，为密码学对称加密算法的流加密。

{{< figureCupper
img="figure4-enigma.jpg"
caption="Egigma 密码机"
command="Resize"
options="480x" >}}

关于谜码机的加密原理我一时之间也搞不清楚，要知道祖师爷 **图灵** 为了破译这个密码都费了老大的功夫了（据说还是没有完成破译工作，对破译工作做出杰出贡献的是三位波兰密码学家马里安·雷耶夫斯基、杰尔兹·罗佐基和亨里克·佐加尔斯基）。详细的内容各位可以参考[wiki](https://zh.wikipedia.org/wiki/恩尼格玛密码机)上的介绍。

如果仅仅对故事感兴趣，大家可以去看看《模仿游戏》这部电影。

{{< figureCupper
img="figure5-the-imitation-game.jpg"
caption="电影《模仿游戏》"
command="Resize"
options="960x" >}}

#### 一次性密码本

[wiki](https://zh.wikipedia.org/wiki/一次性密碼本) 上的介绍

一次性密码本（英语：one-time pad，缩写为OTP）是古典密码学中的一种加密算法。是以随机的密钥（key）加密明文，且只使用一次。

在理论上，此种密码具有完善保密性，是牢不可破的。它的安全性已由克劳德·艾尔伍德·香农所证明。
虽然它在理论上的安全性无庸置疑，但在实际操作上却有着以下的问题：

* 用以加密的文本，也就是一次性密码本，必须确实是随机产生的。
* 它至少必须和被加密的文件等长。
* 用以加密的文本只能用一次，且必须对非关系人小心保密，不再使用时，用以加密的文本应当要销毁，以防重复使用。

文中给了一个说明和例子：

> 首先手上要有一本一次性密码本用以加密文件，接着将一次性密码本里的字母，与被加密文件的字母给依序按某个事先约定的规定一一相混，其中一个相混的作法是将字母指定数字（如在英语中，将A至Z依序指定为0至25）然后将一次性密码文本上的字母所代表的数字和被加密文件上相对应的数字给相加，再除以该语言的字母数后获取其余数，假设字母数是 n（如英语为26），若就此得出来的某个数字小于零，则将该小于零的数给加上n，如此便完成加密。

```
# 明文
This is an example → 19 7 8 18 8 18 0 13 4 23 0 12 15 11 4

# 一次性密码本
MASKL NSFLD FKJPQ → 12 0 18 10 11 13 18 5 11 3 5 10 9 15 16

# 相加
31 7 26 28 19 31 18 18 15 26 5 22 24 26 20

# 取余
5 7 0 2 19 5 18 18 15 0 5 22 24 0 20

# 密文
FHACTFSSPAFWYAU
```

其解密过程反向操作即可。

### 现代密码的工具箱

前边介绍了一些古典加密方法，有简单有复杂，有不安全有安全，但是在我们即将介绍的HTTPS这个场景下，多少有些不适用之处。

这个时候现代密码学工具就要派上用场了。

#### 对称加密（私钥加密）

> 对称密钥演算法（英语：Symmetric-key algorithm）又称为对称加密、私钥加密、共享密钥加密，是密码学中的一类加密算法。这类演算法在加密和解密时使用相同的密钥，或是使用两个可以简单地相互推算的密钥。事实上，这组密钥成为在两个或多个成员间的共同秘密，以便维持专属的通讯联系。与公开密钥加密相比，要求双方取得相同的密钥是对称密钥加密的主要缺点之一。
> 常见的对称加密算法有AES、ChaCha20、3DES、Salsa20、DES、Blowfish、IDEA、RC5、RC6、Camellia。
> 对称加密的速度比公钥加密快很多，在很多场合都需要对称加密。

部分加密算法参考：
* [DES加密](https://zh.wikipedia.org/wiki/資料加密標準)
* [AES加密](https://zh.wikipedia.org/wiki/高级加密标准)


#### 非对称加密（公钥加密）

> 公开密钥密码学（Public-key cryptography）也称非对称式密码学（Asymmetric cryptography）是密码学的一种算法，它需要两个密钥，一个是公开密钥，另一个是私有密钥；公钥用作加密，私钥则用作解密。使用公钥把明文加密后所得的密文，只能用相对应的私钥才能解密并得到原本的明文，最初用来加密的公钥不能用作解密。由于加密和解密需要两个不同的密钥，故被称为非对称加密；不同于加密和解密都使用同一个密钥的对称加密。公钥可以公开，可任意向外发布；私钥不可以公开，必须由用户自行严格秘密保管，绝不透过任何途径向任何人提供，也不会透露给被信任的要通讯的另一方。
> 基于公开密钥加密的特性，它还能提供数字签名的功能，使电子文件可以得到如同在纸本文件上亲笔签署的效果。

看到这个描述，是不是感觉已经接近要讨论的HTTPS了？公钥加密正是解决网络加密通信的一种重要手段，网络上的用户天各一方，不可能事先约定好一个共享密钥进行数据加密吧。那么现在的问题就变成了通信双方如何在公共信道中能获得一组非对称密钥了。

感谢伟大的数学！我们来看看几个常用的方法。

##### RSA加密算法

> RSA加密算法是一种非对称加密算法，在公开密钥加密和电子商业中被广泛使用。RSA是由罗纳德·李维斯特（Ron Rivest）、阿迪·萨莫尔（Adi Shamir）和伦纳德·阿德曼（Leonard Adleman）在1977年一起提出的。当时他们三人都在麻省理工学院工作。RSA 就是他们三人姓氏开头字母拼在一起组成的。

给一个简单的例子解释RSA密钥对生成过程和加密解密。

```
# 生成密钥对
1. 挑选两个随机素数p和q计算它们的乘积
   在实际情况下p和q会比较大
   为了说明这里我们选择p = 3 和 q = 11:

2. 两个质数相乘 n = p * q = 3 * 11 = 33

3. 求 m = φ(n)：（这里m为n的欧拉函数，欧拉函数φ(n)是小于或等于n的正整数中与n互质的数的数目)
    m = φ(n) = (p-1) * (q-1)= 2 * 10 = 20

4. 选出公钥钥中的e:
    e的条件是: e为质数；1<e<m；gcd(e,m) = 1 。这里可以选择 e = 3。

5. 计算私钥中的d：（这里出现了逆模元的概念：d是e对m的模逆元）
	1<d<m and (e * d) mod m = 1
	这里计算出一个可能的结果为 d = 7

# 得到密钥对:
	(e, n) 为公钥 这里为(3, 33)，可以公开。
	(d, n) 为私钥 这里为(7, 33)，用户需要保存好。
	p和q两个数据可以销毁。

# 明文为x 密文为y。
# 加密过程
y = x^e mod n
# 解密过程
x = y^d mod n

# 实际使用
消息：summer
# 用字符顺序0-26编码
18 20 12 12 4 17
# 使用上边得到的密钥对加密 y = x^3 mode 33
密文：24 14 12 12 31 29
# 使用上边得到的密钥对解密 y = x^7 mode 33
明文：18 20 12 12 4 17
# 解码
消息：summer

# 安全性
这种加密方式的安全性来源于一个巨大的数（上边的n）做质因数分解（得到p和q）非常的困难。
例子中知道公钥(3, 33)，想要获取私钥中(d, 33)中的d，就需要知道m，m = (p-1) * (q-1)，
问题变成了需要知道p和q，
又p * q = 33，所以变成了对33的质因数分解，
当33变成一个2048bit的数时，这个分解会变得极度困难。

# 证明过程需要使用一些数学概念
素数/质数
同余
欧拉函数/欧拉定理
逆模元/逆模数
...

求知欲比较强烈的朋友可以去查阅相关资料和证明过程。
```



#### 单向散列函数

#### 消息确认码

#### 数字签名

#### 伪随机数生成器


## 为什么是HTTPS

### HTTP演进历史

### 什么是HTTPS

### 如何实现安全传输


## 有关数字证书

### 数字证书

### 验证过程

### 证书链

### 证书获取方式

### Let's Encrypt

## 参考

* [《图解密码技术》](https://www.ituring.com.cn/book/1737)
* [《HTTPS权威指南》](https://www.ituring.com.cn/book/1734) 
* Let's Encrypt [官方网站](https://letsencrypt.org/zh-cn/)

再多的参考资料都不如自己动手实践，共勉！


